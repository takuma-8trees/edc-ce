name: Multi-Arch Build and Test

on:
  workflow_dispatch:
  push:
    branches: [ feature/multi-arch-docker-image ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY_URL: ghcr.io
  REGISTRY_USER: ${{ github.actor }}
  IMAGE_BASE_NAME: ${{ github.repository_owner }}

jobs:
  build-connector-image-multi-arch:
    name: Build CE Connector Multi-Arch Image (AMD64 + ARM64)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: "Set up JDK 21"
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: "Gradle: Validate Gradle Wrapper"
        uses: gradle/wrapper-validation-action@v3
      
      - name: "Gradle: Build Connector JAR"
        uses: gradle/actions/setup-gradle@v3
        with:
          build-root-directory: connector
          arguments: :ce:docker-image-ce:build -x test
        env:
          USERNAME: ${{ env.REGISTRY_USER }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Set up QEMU for Multi-Arch Build"
        uses: docker/setup-qemu-action@v2
      
      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v2
      
      - name: "Docker: Log in to the Container registry"
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Docker: Store last commit info and build date"
        id: build_info
        run: |
          echo "SOVITY_BUILD_VERSION_ARG=$(git describe --tags ${CI_PR_SHA} 2>/dev/null || git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "SOVITY_BUILD_DATE_ARG=$(date --utc +%FT%TZ)" >> "$GITHUB_OUTPUT"
      
      - name: "Docker: Extract metadata (tags, labels)"
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_BASE_NAME }}/edc-ce
          labels: |
            org.opencontainers.image.title=sovity Community Edition EDC Connector
            org.opencontainers.image.description=Eclipse EDC Connector built by sovity. This image supports multiple data spaces and contains multiple kinds of deployments.
          tags: |
            type=schedule
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=multi-arch-latest
      
      - name: "Docker: Build and Push Multi-Arch Image (AMD64 + ARM64)"
        uses: docker/build-push-action@v4
        with:
          file: connector/ce/docker-image-ce/src/main/docker/Dockerfile
          context: connector/ce/docker-image-ce
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            SOVITY_BUILD_VERSION_ARG=${{ steps.build_info.outputs.SOVITY_BUILD_VERSION_ARG }}
            SOVITY_BUILD_DATE_ARG=${{ steps.build_info.outputs.SOVITY_BUILD_DATE_ARG }}
      
      - name: "Docker: Verify Multi-Arch Manifest"
        run: |
          echo "Verifying multi-arch manifest for edc-ce..."
          docker buildx imagetools inspect ${{ env.REGISTRY_URL }}/${{ env.IMAGE_BASE_NAME }}/edc-ce:multi-arch-latest

  build-connector-ui-image-multi-arch:
    name: Build CE Connector UI Multi-Arch Image (AMD64 + ARM64)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: "Set up Node 20"
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"
          cache: "yarn"
          cache-dependency-path: frontend/yarn.lock
      
      - name: "Install Dependencies"
        working-directory: frontend
        run: yarn install --immutable
      
      - name: "Build Next.js Application"
        working-directory: frontend
        run: yarn build-prod
      
      - name: "Set up QEMU for Multi-Arch Build"
        uses: docker/setup-qemu-action@v2
      
      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v2
      
      - name: "Docker: Log in to the Container registry"
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Docker: Store last commit info and build date"
        id: build_info
        run: |
          echo "NEXT_PUBLIC_BUILD_VERSION_ARG=$(git describe --tags ${CI_PR_SHA} 2>/dev/null || git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "NEXT_PUBLIC_BUILD_DATE_ARG=$(date --utc +%FT%TZ)" >> "$GITHUB_OUTPUT"
      
      - name: "Docker: Extract metadata (tags, labels)"
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY_URL }}/${{ env.IMAGE_BASE_NAME }}/edc-ce-ui
          labels: |
            org.opencontainers.image.title=sovity EDC CE UI
            org.opencontainers.image.description=UI for the sovity EDC CE Connector
          tags: |
            type=schedule
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=ref,event=branch
            type=ref,event=pr
            type=sha
            type=raw,value=multi-arch-latest
      
      - name: "Docker: Build and Push Multi-Arch Image (AMD64 + ARM64)"
        uses: docker/build-push-action@v4
        with:
          file: frontend/Dockerfile
          context: frontend
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_BUILD_VERSION_ARG=${{ steps.build_info.outputs.NEXT_PUBLIC_BUILD_VERSION_ARG }}
            NEXT_PUBLIC_BUILD_DATE_ARG=${{ steps.build_info.outputs.NEXT_PUBLIC_BUILD_DATE_ARG }}
      
      - name: "Docker: Verify Multi-Arch Manifest"
        run: |
          echo "Verifying multi-arch manifest for edc-ce-ui..."
          docker buildx imagetools inspect ${{ env.REGISTRY_URL }}/${{ env.IMAGE_BASE_NAME }}/edc-ce-ui:multi-arch-latest

  run-connector-tests:
    name: Run CE Gradle Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      
      - name: "Set up JDK 21"
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: "Gradle: Validate Gradle Wrapper"
        uses: gradle/wrapper-validation-action@v3
      
      - name: "Gradle: Run All Tests"
        uses: gradle/actions/setup-gradle@v3
        with:
          build-root-directory: connector
          arguments: test -x :ce:docker-image-ce:assemble
        env:
          USERNAME: ${{ env.REGISTRY_USER }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-arm64-image:
    name: Test ARM64 Images
    runs-on: ubuntu-latest
    needs:
      - build-connector-image-multi-arch
      - build-connector-ui-image-multi-arch
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v3
      
      - name: "Set up QEMU for ARM64 Emulation"
        uses: docker/setup-qemu-action@v2
      
      - name: "Docker: Log in to the Container registry"
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY_URL }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Test ARM64 Connector Image"
        run: |
          echo "Testing ARM64 connector image..."
          docker run --rm --platform linux/arm64 \
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_BASE_NAME }}/edc-ce:multi-arch-latest \
            java -version
          echo "✅ ARM64 connector image runs successfully"
      
      - name: "Test ARM64 Frontend Image"
        run: |
          echo "Testing ARM64 frontend image..."
          docker run --rm --platform linux/arm64 \
            -e NEXT_PUBLIC_MANAGEMENT_API_URL=http://localhost:11002/api/management \
            ${{ env.REGISTRY_URL }}/${{ env.IMAGE_BASE_NAME }}/edc-ce-ui:multi-arch-latest \
            node --version
          echo "✅ ARM64 frontend image runs successfully"

  multi-arch-status:
    if: always()
    name: Multi-Arch Build Status
    needs:
      - build-connector-image-multi-arch
      - build-connector-ui-image-multi-arch
      - run-connector-tests
      - test-arm64-image
    runs-on: ubuntu-latest
    steps:
      - name: Decide whether the needed jobs succeeded or failed
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
